<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newton's First Law of Motion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }
        .animation-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subtitle-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 5px 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subtitle {
            color: black;
            border-radius: 30px;
            font-size: 1.4rem;
            max-width: 80%;
            text-align: center;
            line-height: 1.5;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .subtitle.active {
            opacity: 1;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 5px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        .control-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        .control-btn:active {
            transform: scale(0.95);
        }
        .control-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        .progress-container {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
            display: flex;
            align-items: center;
        }
        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
        }
        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #3498db;
            border-radius: 50%;
            cursor: grab;
            left: 0%;
        }
        .progress-handle:active {
            cursor: grabbing;
        }
        .time-display {
            min-width: 100px;
            text-align: center;
            font-size: 0.9rem;
            color: #2c3e50;
            font-weight: 500;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading.active {
            display: flex;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        .loading-text {
            font-size: 1.2rem;
            color: #3498db;
        }
        .cache-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(46, 204, 113, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: none;
        }
        .cache-indicator.active {
            display: block;
        }
        .scene-number {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.8);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .physics-scene {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .force-arrow {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .force-arrow.active {
            opacity: 1;
        }
        .text-panel {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 40%;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
            opacity: 0;
            transition: opacity 0.5s ease;
            display: none; /* Hide text panel as requested */
        }
        .text-panel.active {
            opacity: 1;
        }
        .visual-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 50%;
            height: 70%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scene-title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: 300;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .scene-title.active {
            opacity: 1;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        @media (max-width: 768px) {
            .animation-container {
                padding: 20px;
                min-height: 300px;
            }
            
            .subtitle {
                font-size: 1rem;
                padding: 12px 20px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
            }
            
            .text-panel {
                width: 90%;
                left: 5%;
                right: 5%;
                font-size: 0.9rem;
            }
            
            .visual-panel {
                width: 90%;
                left: 5%;
                right: 5%;
                top: auto;
                bottom: 20px;
                height: 40%;
            }
            
            .scene-title {
                font-size: 1.4rem;
            }
            
            .scene-number {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            
            .time-display {
                min-width: 80px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="animation-container">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading...</div>
            </div>
            <div class="cache-indicator" id="cacheIndicator">Using cached audio</div>
            <div class="scene-number" id="sceneNumber">1</div>
            
            <svg class="physics-scene" viewBox="0 0 800 400">
                <!-- 背景网格 -->
                <defs>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e0e0e0" stroke-width="1"/>
                    </pattern>
                    
                    <!-- 渐变定义 -->
                    <linearGradient id="ballGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="arrowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#c0392b;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="velocityGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <rect width="800" height="400" fill="url(#grid)" />
                
                <!-- 地面 -->
                <rect x="0" y="350" width="800" height="50" fill="#95a5a6" opacity="0.3"/>
                
                <!-- 文本面板 -->
                <foreignObject x="20" y="20" width="350" height="200" class="text-panel" id="textPanel">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="padding: 10px;">
                        <p id="textContent"></p>
                    </div>
                </foreignObject>
                
                <!-- 场景标题 -->
                <text x="800" y="30" text-anchor="middle" fill="#2c3e50" font-size="24" font-weight="300" class="scene-title" id="sceneTitle">
                    Introduction to Newton's First Law
                </text>
                
                <!-- 视觉面板 -->
                <g id="visualPanel">
                    <!-- Scene 1: Introduction -->
                    <g id="scene1">
                        <!-- 静止的小球 -->
                        <circle cx="550" cy="300" r="30" fill="url(#ballGradient)"/>
                        <text x="550" y="340" text-anchor="middle" fill="#2c3e50" font-size="16">Object at rest</text>
                        
                        <!-- 运动的小球 -->
                        <circle cx="650" cy="200" r="30" fill="url(#ballGradient)">
                            <animateTransform attributeName="transform" type="translate" from="0 0" to="100 0" dur="3s" repeatCount="indefinite"/>
                        </circle>
                        <text x="700" y="240" text-anchor="middle" fill="#2c3e50" font-size="16">Object in motion</text>
                        
                        <!-- 速度矢量 -->
                        <line x1="680" y1="200" x2="720" y2="200" stroke="url(#velocityGradient)" stroke-width="3" marker-end="url(#velocityArrowhead)"/>
                        <text x="700" y="185" text-anchor="middle" fill="#2ecc71" font-size="16">v</text>
                    </g>
                    
                    <!-- Scene 2: Understanding Inertia -->
                    <g id="scene2" style="display: none;">
                        <!-- 卡车 -->
                        <rect x="500" y="270" width="120" height="60" fill="#7f8c8d" rx="5"/>
                        <circle cx="520" cy="330" r="15" fill="#34495e"/>
                        <circle cx="600" cy="330" r="15" fill="#34495e"/>
                        <text x="560" y="360" text-anchor="middle" fill="#2c3e50" font-size="16">Truck (high mass)</text>
                        
                        <!-- 自行车 -->
                        <rect x="650" y="290" width="60" height="40" fill="#3498db" rx="5"/>
                        <circle cx="660" cy="330" r="10" fill="#34495e"/>
                        <circle cx="700" cy="330" r="10" fill="#34495e"/>
                        <text x="680" y="360" text-anchor="middle" fill="#2c3e50" font-size="16">Bicycle (low mass)</text>
                        
                        <!-- 力的箭头 -->
                        <line x1="480" y1="300" x2="500" y2="300" stroke="url(#arrowGradient)" stroke-width="5" marker-end="url(#arrowhead)"/>
                        <line x1="630" y1="310" x2="650" y2="310" stroke="url(#arrowGradient)" stroke-width="5" marker-end="url(#arrowhead)"/>
                        <text x="440" y="300" text-anchor="middle" fill="#e74c3c" font-size="16">F</text>
                        <text x="615" y="310" text-anchor="middle" fill="#e74c3c" font-size="16">F</text>
                    </g>
                    
                    <!-- Scene 3: Objects at Rest -->
                    <g id="scene3" style="display: none;">
                        <!-- 桌子上的书 -->
                        <rect x="500" y="250" width="80" height="100" fill="#e74c3c" rx="2"/>
                        <rect x="480" y="350" width="120" height="10" fill="#8b6f47"/>
                        <text x="540" y="380" text-anchor="middle" fill="#2c3e50" font-size="16">Book on table</text>
                        
                        <!-- 力的箭头 -->
                        <line x1="540" y1="250" x2="540" y2="220" stroke="url(#arrowGradient)" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <line x1="540" y1="350" x2="540" y2="380" stroke="url(#arrowGradient)" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <text x="560" y="235" text-anchor="middle" fill="#e74c3c" font-size="14">Weight</text>
                        <text x="560" y="375" text-anchor="middle" fill="#e74c3c" font-size="14">Normal</text>
                    </g>
                    
                    <!-- Scene 4: Objects in Motion -->
                    <g id="scene4" style="display: none;">
                        <!-- 冰球 -->
                        <circle cx="550" cy="300" r="20" fill="#34495e">
                            <animateTransform attributeName="transform" type="translate" from="0 0" to="200 0" dur="5s" repeatCount="indefinite"/>
                        </circle>
                        <rect x="500" y="320" width="300" height="30" fill="#ecf0f1" rx="5"/>
                        <text x="650" y="370" text-anchor="middle" fill="#2c3e50" font-size="16">Hockey puck on ice</text>
                        
                        <!-- 速度矢量 -->
                        <line x1="570" y1="300" x2="610" y2="300" stroke="url(#velocityGradient)" stroke-width="3" marker-end="url(#velocityArrowhead)"/>
                        <text x="590" y="285" text-anchor="middle" fill="#2ecc71" font-size="16">v</text>
                    </g>
                    
                    <!-- Scene 5: Unbalanced Forces -->
                    <g id="scene5" style="display: none;">
                        <!-- 被踢的球 -->
                        <circle cx="550" cy="300" r="30" fill="url(#ballGradient)"/>
                        <text x="550" y="340" text-anchor="middle" fill="#2c3e50" font-size="16">Ball being kicked</text>
                        
                        <!-- 力的箭头 -->
                        <line x1="480" y1="300" x2="520" y2="300" stroke="url(#arrowGradient)" stroke-width="5" marker-end="url(#arrowhead)"/>
                        <text x="450" y="300" text-anchor="middle" fill="#e74c3c" font-size="16">F</text>
                    </g>
                    
                    <!-- Scene 6: Real-World Applications -->
                    <g id="scene6" style="display: none;">
                        <!-- 汽车 -->
                        <rect x="500" y="270" width="100" height="50" fill="#3498db" rx="5"/>
                        <circle cx="520" cy="320" r="12" fill="#34495e"/>
                        <circle cx="580" cy="320" r="12" fill="#34495e"/>
                        <text x="550" y="350" text-anchor="middle" fill="#2c3e50" font-size="16">Car stopping</text>
                        
                        <!-- 人 -->
                        <circle cx="620" cy="260" r="10" fill="#f39c12"/>
                        <rect x="615" y="270" width="10" height="30" fill="#f39c12"/>
                        <line x1="615" y1="280" x2="605" y2="290" stroke="#f39c12" stroke-width="3"/>
                        <line x1="625" y1="280" x2="635" y2="290" stroke="#f39c12" stroke-width="3"/>
                        
                        <!-- 力的箭头 -->
                        <line x1="620" y1="260" x2="650" y2="260" stroke="url(#velocityGradient)" stroke-width="3" marker-end="url(#velocityArrowhead)"/>
                        <text x="635" y="245" text-anchor="middle" fill="#2ecc71" font-size="14">v</text>
                    </g>
                </g>
                
                <!-- 箭头标记定义 -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="url(#arrowGradient)" />
                    </marker>
                    
                    <marker id="velocityArrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="url(#velocityGradient)" />
                    </marker>
                </defs>
            </svg>
        </div>
        
        <div class="subtitle-container">
            <div class="subtitle" id="subtitle"></div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="playBtn" title="Play" disabled>
                <span id="playIcon">▶</span>
            </button>
            <button class="control-btn" id="muteBtn" title="Mute">
                <span id="muteIcon">🔊</span>
            </button>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                </div>
                <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        © 2023 https://study11.ai/
    </div>
    
    <!-- 为每个场景创建一个音频元素 -->
    <div id="audioContainer"></div>
    
    <script>
        // 动画场景数据
        const scenes = [
            {
                title: "Introduction to Newton's First Law",
                subtitle: "Newton's First Law states: An object at rest stays at rest and an object in motion stays in motion with the same speed and in the same direction unless acted upon by an unbalanced force.",
                action: () => {
                    // 显示场景1，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 1 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Introduction to Newton's First Law";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '1';
                }
            },
            {
                title: "Understanding Inertia",
                subtitle: "Inertia is an object's resistance to changes in its state of motion. The greater the mass of an object, the greater its inertia and the more force it takes to change its motion.",
                action: () => {
                    // 显示场景2，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 2 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Understanding Inertia";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '2';
                }
            },
            {
                title: "Objects at Rest",
                subtitle: "An object at rest will remain at rest unless acted upon by an unbalanced force. When multiple forces act on an object but cancel each other out, the object remains in equilibrium.",
                action: () => {
                    // 显示场景3，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 3 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Objects at Rest";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '3';
                }
            },
            {
                title: "Objects in Motion",
                subtitle: "An object in motion will continue in motion with the same speed and in the same direction unless acted upon by an unbalanced force. This describes uniform motion in ideal frictionless conditions.",
                action: () => {
                    // 显示场景4，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 4 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Objects in Motion";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '4';
                }
            },
            {
                title: "Unbalanced Forces and Motion Changes",
                subtitle: "When an unbalanced force acts on an object, it causes acceleration, changing the object's speed, direction, or both. This is the exception to Newton's First Law.",
                action: () => {
                    // 显示场景5，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 5 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Unbalanced Forces and Motion Changes";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '5';
                }
            },
            {
                title: "Real-World Applications",
                subtitle: "Newton's First Law explains many everyday phenomena, from the need for seatbelts to why astronauts float in space. Understanding inertia helps us design safer and more efficient systems.",
                action: () => {
                    // 显示场景6，隐藏其他场景
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`scene${i}`).style.display = i === 6 ? 'block' : 'none';
                    }
                    // 更新标题
                    document.getElementById('sceneTitle').textContent = "Real-World Applications";
                    document.getElementById('sceneTitle').classList.add('active');
                    // 更新场景编号
                    document.getElementById('sceneNumber').textContent = '6';
                }
            }
        ];
        
        // 全局变量
        let currentScene = 0;
        let isPlaying = false;
        let isMuted = false;
        let audioElements = [];
        let sceneStartTime = 0;
        let totalDuration = 0;
        let sceneTimestamps = []; // 记录每个场景的开始时间戳
        let isDragging = false;
        let audioCache = {}; // 音频缓存对象
        let cacheExpiry = 7 * 24 * 60 * 60 * 1000; // 缓存有效期：7天
        let pausedScene = 0;
        let pausedTime = 0;
        let wasPausedByUser = false;
        
        // DOM元素
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const muteBtn = document.getElementById('muteBtn');
        const muteIcon = document.getElementById('muteIcon');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const progressHandle = document.getElementById('progressHandle');
        const subtitle = document.getElementById('subtitle');
        const loading = document.getElementById('loading');
        const audioContainer = document.getElementById('audioContainer');
        const cacheIndicator = document.getElementById('cacheIndicator');
        const timeDisplay = document.getElementById('timeDisplay');
        const sceneTitle = document.getElementById('sceneTitle');
        const sceneNumber = document.getElementById('sceneNumber');
        
        // 初始化音频缓存
        function initAudioCache() {
            try {
                // 尝试从localStorage加载缓存
                const cachedData = localStorage.getItem('ttsAudioCache');
                if (cachedData) {
                    const parsedCache = JSON.parse(cachedData);
                    
                    // 检查缓存是否过期
                    const now = Date.now();
                    for (const key in parsedCache) {
                        if (parsedCache[key].timestamp + cacheExpiry < now) {
                            delete parsedCache[key]; // 删除过期缓存
                        }
                    }
                    
                    audioCache = parsedCache;
                    // 保存更新后的缓存
                    localStorage.setItem('ttsAudioCache', JSON.stringify(audioCache));
                }
            } catch (e) {
                console.error('初始化音频缓存失败:', e);
                audioCache = {};
            }
        }
        
        // 将Blob转换为Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // 将Base64转换为Blob
        function base64ToBlob(base64) {
            // 分离Base64数据和MIME类型
            const parts = base64.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            
            // 转换为ArrayBuffer
            const uInt8Array = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            
            // 创建Blob
            return new Blob([uInt8Array], { type: contentType });
        }
        
        // 保存音频到缓存
        async function saveAudioToCache(text, blob) {
            try {
                // 将Blob转换为Base64字符串
                const base64Data = await blobToBase64(blob);
                
                audioCache[text] = {
                    data: base64Data,
                    timestamp: Date.now()
                };
                localStorage.setItem('ttsAudioCache', JSON.stringify(audioCache));
            } catch (e) {
                console.error('保存音频缓存失败:', e);
            }
        }
        
        // 从缓存获取音频
        function getAudioFromCache(text) {
            if (audioCache[text] && audioCache[text].timestamp + cacheExpiry > Date.now()) {
                try {
                    // 将Base64转换回Blob
                    const blob = base64ToBlob(audioCache[text].data);
                    return URL.createObjectURL(blob);
                } catch (e) {
                    console.error('从缓存恢复音频失败:', e);
                    return null;
                }
            }
            return null;
        }
        
        // 初始化音频元素
        function initializeAudioElements() {
            // 清空容器
            audioContainer.innerHTML = '';
            audioElements = [];
            
            // 为每个场景创建音频元素
            scenes.forEach((scene, index) => {
                const audio = document.createElement('audio');
                audio.id = `audio-${index}`;
                audio.preload = 'auto';
                audioContainer.appendChild(audio);
                audioElements.push(audio);
            });
        }
        
        // 合成单个场景的语音
        async function synthesizeSceneSpeech(index) {
            const text = scenes[index].subtitle;
            const encodedText = encodeURIComponent(text);
            
            // 检查缓存
            const cachedAudioUrl = getAudioFromCache(text);
            if (cachedAudioUrl) {
                // 显示缓存指示器
                cacheIndicator.classList.add('active');
                setTimeout(() => {
                    cacheIndicator.classList.remove('active');
                }, 2000);
                
                // 使用缓存的音频
                audioElements[index].src = cachedAudioUrl;
                
                // 等待音频加载完成以获取时长
                return new Promise((resolve) => {
                    audioElements[index].onloadedmetadata = () => {
                        scenes[index].duration = audioElements[index].duration * 1000; // 转换为毫秒
                        resolve();
                    };
                });
            }
            
            // 缓存中没有，请求TTS服务
            try {
                const response = await fetch(`https://javalinux.explanation.fun/tts?input=${encodedText}`);
                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);
                
                // 保存到缓存
                await saveAudioToCache(text, blob);
                
                audioElements[index].src = audioUrl;
                
                // 等待音频加载完成以获取时长
                return new Promise((resolve) => {
                    audioElements[index].onloadedmetadata = () => {
                        scenes[index].duration = audioElements[index].duration * 1000; // 转换为毫秒
                        resolve();
                    };
                });
            } catch (error) {
                console.error(`场景 ${index} TTS合成失败:`, error);
                // 使用默认持续时间
                scenes[index].duration = 5000;
                resolve();
            }
        }
        
        // 格式化时间显示
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 更新时间显示
        function updateTimeDisplay(currentTime, totalTime) {
            const currentTimeStr = formatTime(currentTime);
            const totalTimeStr = formatTime(totalTime);
            timeDisplay.textContent = `${currentTimeStr} / ${totalTimeStr}`;
        }
        
        // 预加载所有音频
        async function preloadAllAudio() {
            loading.classList.add('active');
            playBtn.disabled = true;
            
            // 初始化音频缓存
            initAudioCache();
            
            initializeAudioElements();
            
            // 顺序合成每个场景的语音
            for (let i = 0; i < scenes.length; i++) {
                await synthesizeSceneSpeech(i);
            }
            
            // 计算时间戳
            calculateTimestamps();
            
            // 初始化时间显示
            updateTimeDisplay(0, totalDuration);
            
            loading.classList.remove('active');
            playBtn.disabled = false;
        }
        
        // 计算每个场景的时间戳
        function calculateTimestamps() {
            sceneTimestamps = [];
            let accumulatedTime = 0;
            
            scenes.forEach((scene) => {
                sceneTimestamps.push(accumulatedTime);
                accumulatedTime += scene.duration;
            });
            
            totalDuration = accumulatedTime;
        }
        
        // 更新进度条
        function updateProgress() {
            if (!isPlaying) return;
            
            const currentAudio = audioElements[currentScene];
            if (!currentAudio) return;
            
            // 计算当前时间点
            const sceneStartTime = sceneTimestamps[currentScene];
            const currentTime = sceneStartTime + (currentAudio.currentTime * 1000);
            const progress = Math.min((currentTime / totalDuration) * 100, 100);
            
            progressFill.style.width = progress + '%';
            progressHandle.style.left = progress + '%';
            
            // 更新时间显示
            updateTimeDisplay(currentTime, totalDuration);
            
            if (progress >= 100) {
                stopAnimation();
            } else {
                requestAnimationFrame(updateProgress);
            }
        }
        
        // 播放指定场景
        function playScene(sceneIndex) {
            if (sceneIndex >= scenes.length) {
                stopAnimation();
                return;
            }
            
            // 停止当前音频
            if (currentScene < audioElements.length && audioElements[currentScene]) {
                audioElements[currentScene].pause();
            }
            
            currentScene = sceneIndex;
            const scene = scenes[sceneIndex];
            const audio = audioElements[sceneIndex];
            
            // 更新字幕和动画
            subtitle.textContent = scene.subtitle;
            subtitle.classList.add('active');
            scene.action();
            
            // 播放音频
            if (audio && !isMuted) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('音频播放失败:', e));
                
                // 音频结束时播放下一个场景
                audio.onended = () => {
                    subtitle.classList.remove('active');
                    playScene(currentScene + 1);
                };
            } else {
                // 如果静音或没有音频，使用定时器
                setTimeout(() => {
                    subtitle.classList.remove('active');
                    playScene(currentScene + 1);
                }, scene.duration);
            }
        }
        
        // 开始动画
        function startAnimation() {
            if (isPlaying) return;
            
            isPlaying = true;
            playIcon.textContent = '⏸';
            
            if (wasPausedByUser && pausedScene < scenes.length) {
                // 从暂停的状态恢复播放
                const scene = scenes[pausedScene];
                const audio = audioElements[pausedScene];
                
                // 更新字幕和动画
                subtitle.textContent = scene.subtitle;
                subtitle.classList.add('active');
                scene.action();
                
                // 设置当前场景
                currentScene = pausedScene;
                
                // 播放音频（从暂停的时间点开始）
                if (audio && !isMuted) {
                    audio.currentTime = pausedTime / 1000; // 转换为秒
                    audio.play().catch(e => console.log('音频播放失败:', e));
                    
                    // 音频结束时播放下一个场景
                    audio.onended = () => {
                        subtitle.classList.remove('active');
                        playScene(currentScene + 1);
                    };
                } else {
                    // 如果静音或没有音频，使用定时器
                    setTimeout(() => {
                        subtitle.classList.remove('active');
                        playScene(currentScene + 1);
                    }, scene.duration - pausedTime);
                }
                
                wasPausedByUser = false;
            } else {
                // 从头开始播放
                currentScene = 0;
                playScene(0);
            }
            
            updateProgress();
        }
        
        // 暂停动画
        function pauseAnimation() {
            isPlaying = false;
            playIcon.textContent = '▶';
            wasPausedByUser = true;
            
            // 保存当前播放状态
            if (currentScene < audioElements.length && audioElements[currentScene]) {
                const audio = audioElements[currentScene];
                pausedScene = currentScene;
                pausedTime = audio.currentTime * 1000; // 转换为毫秒
                
                // 暂停当前音频
                audio.pause();
            }
        }
        
        // 停止动画
        function stopAnimation() {
            pauseAnimation();
            currentScene = 0;
            pausedScene = 0;
            pausedTime = 0;
            wasPausedByUser = false;
            progressFill.style.width = '0%';
            progressHandle.style.left = '0%';
            subtitle.textContent = '';
            
            // 重置时间显示
            updateTimeDisplay(0, totalDuration);
            
            // 隐藏所有场景
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`scene${i}`).style.display = 'none';
            }
            
            // 隐藏标题
            sceneTitle.classList.remove('active');
            // 重置场景编号
            sceneNumber.textContent = '1';
        }
        
        // 切换静音
        function toggleMute() {
            isMuted = !isMuted;
            muteIcon.textContent = isMuted ? '🔇' : '🔊';
            
            // 设置所有音频元素的静音状态
            audioElements.forEach(audio => {
                audio.muted = isMuted;
            });
        }
        
        // 进度条控制
        function handleProgressClick(e) {
            const rect = progressBar.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            
            progressFill.style.width = percentage + '%';
            progressHandle.style.left = percentage + '%';
            
            // 计算对应的时间点
            const targetTime = (percentage / 100) * totalDuration;
            
            // 更新时间显示
            updateTimeDisplay(targetTime, totalDuration);
            
            // 找到对应的场景
            let targetScene = 0;
            for (let i = 0; i < sceneTimestamps.length; i++) {
                if (targetTime >= sceneTimestamps[i]) {
                    targetScene = i;
                } else {
                    break;
                }
            }
            
            // 更新暂停状态
            pausedScene = targetScene;
            pausedTime = targetTime - sceneTimestamps[targetScene];
            
            // 如果正在播放，跳转到目标场景
            if (isPlaying) {
                // 停止当前音频
                if (currentScene < audioElements.length && audioElements[currentScene]) {
                    audioElements[currentScene].pause();
                }
                
                // 计算在目标场景中的时间偏移
                const sceneOffset = targetTime - sceneTimestamps[targetScene];
                
                // 播放目标场景
                currentScene = targetScene;
                const scene = scenes[targetScene];
                const audio = audioElements[targetScene];
                
                // 更新字幕和动画
                subtitle.textContent = scene.subtitle;
                subtitle.classList.add('active');
                scene.action();
                
                // 播放音频（从指定时间点开始）
                if (audio && !isMuted) {
                    audio.currentTime = sceneOffset / 1000; // 转换为秒
                    audio.play().catch(e => console.log('音频播放失败:', e));
                    
                    // 音频结束时播放下一个场景
                    audio.onended = () => {
                        subtitle.classList.remove('active');
                        playScene(currentScene + 1);
                    };
                } else {
                    // 如果静音或没有音频，使用定时器
                    setTimeout(() => {
                        subtitle.classList.remove('active');
                        playScene(currentScene + 1);
                    }, scene.duration - sceneOffset);
                }
            } else if (wasPausedByUser) {
                // 如果是暂停状态，更新场景显示但不播放
                currentScene = targetScene;
                const scene = scenes[targetScene];
                
                // 更新字幕和动画
                subtitle.textContent = scene.subtitle;
                subtitle.classList.add('active');
                scene.action();
            }
        }
        
        // 事件监听
        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                pauseAnimation();
            } else {
                startAnimation();
            }
        });
        
        muteBtn.addEventListener('click', toggleMute);
        progressBar.addEventListener('click', handleProgressClick);
        
        // 进度条拖动
        progressHandle.addEventListener('mousedown', () => isDragging = true);
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                handleProgressClick(e);
            }
        });
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
            }
        });
        
        // 初始化
        window.addEventListener('load', () => {
            preloadAllAudio();
        });
    </script>
</body>
</html>